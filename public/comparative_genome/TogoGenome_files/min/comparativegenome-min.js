function wrapInner(t){return'<div class="inner">'+t+"</div>"}function getNodeWithName(t,e,i){var n=!1,a,s={};for(a=0;a<t.length;a++)if(t[a].name===e){n=!0;break}return n||(s.name=e,s.isLeaf=!1,i?s.children=[]:s._children=[],t.push(s)),t[a]._children?t[a]._children:t[a].children}function intersect(t,e){var i,n,a,s,o,r;return i=Math.max(t.x,e.x),n=Math.max(t.y,e.y),a=Math.min(t.x+t.width,e.x+e.width),s=Math.min(t.y+t.height,e.y+e.height),o=a-i,r=s-n,o>0&&r>0?{x:i,y:n,width:o,height:r}:{x:0,y:0,width:0,height:0}}function Tree(t){for(var e=0,i,n,a,s,o=!0,r=0;r<t.length;r++){i=t[r],s=-1!==DEFAULT.species.indexOf(parseInt(i.taxid)),n=i.clade,a=getNodeWithName(this.taxonomy.children,i.domain,s),e=e>n.length?e:n.length;for(var c=0;c<n.length;c++)a=getNodeWithName(a,n[c],s);i.name=i.common_name,i.isLeaf=!0,a.push(i)}e+=3;var l=TREE.svgHeight,d=320,h=[100,0],p;p=d3.behavior.zoom().translate(h).scaleExtent([.25,8]).on("zoom",function(){this.treeGroup.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}.bind(this)),this.svg=d3.select("#species-selector").append("svg"),this.svg.append("rect").attr("class","event-capture").call(p),this.treeGroup=this.svg.append("g").attr("transform","translate("+h+")"),this.tree=d3.layout.tree().nodeSize([TREE.width,TREE.lineHeight]).separation(function(t,e){return t.parent===e.parent?1:1.5}).size([l,d]),this.diagonal=d3.svg.diagonal().projection(function(t){return[t.y,t.x]}),this.taxonomy.x0=d/2,this.taxonomy.y0=0,this.update(this.taxonomy),this.$speciesSelector=$("#species-selector"),this.speciesSelectorWidthMargin=window.innerWidth-this.$speciesSelector.width(),this.$speciesSelector.find(".toggle-button").on("click",function(){o?(this.$speciesSelector.css("width","").addClass("closed"),$(window).off("resize.species-selector")):(this.$speciesSelector.removeClass("closed"),$(window).on("resize.species-selector",this.resize.bind(this)).triggerHandler("resize.species-selector")),o=!o,window.setTimeout(function(){$(window).triggerHandler("scroll.headingNavigation")},DURATION.css+100)}.bind(this)),$(window).on("resize.species-selector",this.resize.bind(this)).triggerHandler("resize.species-selector")}function Species(t,e,i){var n;this.index=e,this.data=t,this.taxId=t.taxid,this.wikipedia=t.wikipedia,this.targetNode=i,this.$container||(this.$container=$("#section-species").children(".species-container")),n='<div class="species" data-index="@@index@@">			<div class="color-ball"></div>			<h3>@@common_name@@</h3>			<p class="scientific-name">@@scientific_name@@</p>			<div class="close-button"></div>		</div>'.replace(/@@index@@/,this.index+"").replace(/@@common_name@@/,t.common_name+"").replace(/@@scientific_name@@/,t.scientific_name),this.$container.append(n),this.$=this.$container.children(".species").last(),this.$.find(".close-button").on("click",this.clickCloseButton.bind(this))}function VennDiagram(t,e){this.vennDiagram=t,this.$vennDiagram=$(t),this.$parent=$(e),this.vennDiagramHeight=this.$vennDiagram.height()}function HeadingNavigation(){var t=this,e=$(".section > header").height(),i=$(".section");this.sections=[],this.$window=$(window),this.$scroll=$("body, html"),i.each(function(n){var a=$(this),s=a.children("header");t.sections.push({$section:a,$heading:s,top:e*n,bottom:e*(i.length-1-n),position:void 0}),s.data("index",n).on("click",function(){a.hasClass("disabled")||t.scrollTo($(this).data("index"))})}),this.$window.on("scroll.headingNavigation",this.scroll.bind(this)).triggerHandler("scroll.headingNavigation")}function Application(){}const ENDPOINT="http://dev.togogenome.org/sparql-test",DEFAULT={aspect:"pathway",species:[9606,10090,10116]},DURATION={scroll:250,css:200},TREE={svgHeight:320,lineHeight:32,width:200,nodeSize:8,nodeStrokeWidth:2},SPARQLS={step1:'			DEFINE sql:select-option "order"\n			\n			PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n			PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n			PREFIX up: <http://purl.uniprot.org/core/>\n			PREFIX tax: <http://purl.uniprot.org/taxonomy/>\n			PREFIX db: <http://purl.uniprot.org/database/>\n			\n			SELECT ?orgs (COUNT(?orgs) AS ?count)\n			WHERE {\n				SELECT ?label (GROUP_CONCAT(REPLACE(STR(?tax), tax:, "") ;	separator=", ") AS ?orgs)\n				WHERE {\n					SELECT DISTINCT ?label ?tax\n					FROM <http://togogenome.org/graph/uniprot>\n					WHERE {\n						VALUES ?tax { @@taxvalues@@ }\n						?up up:organism ?tax .\n						@@aspect@@\n					}\n					ORDER BY ?tax\n				}\n			}\n			ORDER BY DESC(?count)',step2:'			DEFINE sql:select-option "order"\n			\n			PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n			PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n			PREFIX up: <http://purl.uniprot.org/core/>\n			PREFIX tax: <http://purl.uniprot.org/taxonomy/>\n			PREFIX db: <http://purl.uniprot.org/database/>\n			\n			SELECT DISTINCT ?label ?sum ?orgs\n			WHERE {\n				{\n					SELECT ?label (SUM(?count) AS ?sum) (GROUP_CONCAT(REPLACE(STR(?tax), tax:, "") ;	separator=", ") AS ?orgs)\n					WHERE {\n						SELECT ?label ?tax (COUNT(?up) AS ?count)\n						WHERE {\n							SELECT DISTINCT ?label ?tax ?up\n							FROM <http://togogenome.org/graph/uniprot>\n							WHERE {\n								VALUES ?tax { @@taxvalues@@ }\n								?up up:organism ?tax .\n								@@aspect@@\n							}\n						}\n						ORDER BY ?tax\n					}\n				}\n				FILTER (?orgs = "@@taxfilter@@")\n			}\n			ORDER BY DESC(?sum)',step3:'			DEFINE sql:select-option "order"\n			\n			PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\n			PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\n			PREFIX up: <http://purl.uniprot.org/core/>\n			PREFIX tax: <http://purl.uniprot.org/taxonomy/>\n			PREFIX db: <http://purl.uniprot.org/database/>\n			\n			#SELECT DISTINCT ?tg_id ?up_id ?tax_id ?up ?tax\n			SELECT DISTINCT ?tg_id ?up_id ?tax_id\n			WHERE {\n				GRAPH <http://togogenome.org/graph/uniprot> {\n					VALUES ?label { @@category@@ }\n					VALUES ?tax { @@taxvalues@@ }\n					?up up:organism ?tax .\n					@@aspect@@\n				}\n				GRAPH <http://togogenome.org/graph/tgup> {\n					?up_id rdfs:seeAlso ?up .\n					?tg_id rdfs:seeAlso ?up_id .\n					?tg_id rdfs:seeAlso ?tax_id .\n					?tax_id a <http://identifiers.org/taxonomy> .\n				}\n			}\n			ORDER BY (?tax_id)'},LINKS_TO_HEADER_LABEL_MAPPING={tg_id:"TogoGenome ID",up_id:"UniProt ID",tax_id:"Taxonomy ID"};var application;Tree.prototype={DURATION:750,taxonomy:{name:"Taxonomy",children:[],isLeaf:!1},nodeIndex:0,svg:void 0,treeGroup:void 0,tree:void 0,diagonal:void 0,update:function(t){var e,i,n,a,s,o,r,c,l=this;e=this.tree.nodes(this.taxonomy).reverse(),r=this.tree.links(e),e.forEach(function(t){t.y=180*t.depth}),i=this.treeGroup.selectAll("g.node").data(e,function(t){return t.id||(t.id=++this.nodeIndex)}.bind(this)),n=i.enter().append("g").attr({"class":function(t){return"node"+(t.isLeaf?" leaf":"")+(t._children?" collapsed":"")+(t.children?" expanded":"")},transform:function(){return"translate("+[t.y0,t.x0]+")"}}).on("click",function(t){console.log(arguments),t.isLeaf?t.isSelected?(t.isSelected=!1,d3.select(this).classed({selected:!1}),application.deleteSpecies(t,this)):application.setSpecies(t,this)&&(t.isSelected=!0,d3.select(this).classed({selected:!0})):(t._children?(d3.select(this).classed({collapsed:!1,expanded:!0}),t.children=t._children,t._children=null):(d3.select(this).classed({collapsed:!0,expanded:!1}),t._children=t.children,t.children=null),l.update(t))}),n.append("circle").attr("r",1e-6),n.append("text").attr("text-anchor",function(t){return t.isLeaf?"start":"end"}).text(function(t){return t.name}).style("fill-opacity",1e-6),a=i.transition().duration(this.DURATION).attr("transform",function(t){return"translate("+[t.y,t.x]+")"}),a.select("circle").attr("r",TREE.nodeSize-TREE.nodeStrokeWidth),a.select("text").style("fill-opacity",1),s=i.exit().transition().duration(this.DURATION).attr("transform",function(){return"translate("+[t.y,t.x]+")"}).remove(),s.select("circle").attr("r",1e-6),s.select("text").style("fill-opacity",1e-6),o=this.treeGroup.selectAll(".node.leaf"),o.attr("data-tax-id",function(t){return t.taxid}),o.selectAll("circle").attr("r",TREE.nodeSize),o.append("rect").attr({"class":"plus1",width:2,height:8}),o.append("rect").attr({"class":"plus2",width:8,height:2}),c=this.treeGroup.selectAll("path.link").data(r,function(t){return t.target.id}),c.enter().insert("path","g").attr({"class":"link",d:function(){var e={x:t.x0,y:t.y0};return this.diagonal({source:e,target:e})}.bind(this)}),c.transition().duration(this.DURATION).attr("d",this.diagonal),c.exit().transition().duration(this.DURATION).attr("d",function(){var e={x:t.x,y:t.y};return this.diagonal({source:e,target:e})}.bind(this)).remove(),e.forEach(function(t){t.x0=t.x,t.y0=t.y})},resize:function(){console.log(window.innerWidth),console.log(this.speciesSelectorWidthMargin),this.$speciesSelector.width("calc(100% - 24px)")}},Species.prototype={$container:void 0,clickCloseButton:function(){var t=new MouseEvent("click");this.targetNode.dispatchEvent(t)},updateByDeleteTaxId:function(t,e){return t===this.data.taxid?(window.console.log("消す"),this.$.remove(),!0):(this.index=e,this.$.attr("data-index",e),!1)}},VennDiagram.prototype={MARGIN_TOP:80,MARGIN_BOTTOM:80,FIXED_TOP:110,scroll:function(){window.scrollY+this.MARGIN_TOP>this.$parent.offset().top?this.$vennDiagram.css({position:"fixed",top:this.FIXED_TOP}):this.$vennDiagram.css({position:"",top:""})}},HeadingNavigation.prototype={scroll:function(){var t=this.$window.scrollTop(),e=this.$window.innerHeight(),i=46;this.sections.forEach(function(n){var a=n.$section.offset().top,s=n.$heading.height(),o=0;if(t>a-n.top-i&&(o=-1),t+e<a+s+n.bottom&&(o=1),n.position!==o)switch(n.position=o,o){case-1:n.$section.addClass("sticked").removeClass("bottom"),n.$heading.css({top:n.top+i,bottom:""});break;case 0:n.$section.removeClass("sticked").addClass("bottom"),n.$heading.css({top:"",bottom:""});break;case 1:n.$section.addClass("sticked bottom"),n.$heading.css({top:"",bottom:n.bottom})}})},scrollTo:function(t){this.$scroll.animate({scrollTop:this.sections[t].$section.offset().top-this.sections[t].top+2},{duration:DURATION.scroll})}},Application.prototype={MAX_OF_TAXON:5,initialize:function(t){var e=this,i;this.$aspectH2=$("#section-aspect h2 strong"),this.$speciesH2=$("#section-species h2 strong"),this.$combinationH2=$("#section-combination h2 strong"),this.$categoryH2=$("#section-category h2 strong"),this.$sectionSpecies=$("#section-species"),this.$sectionSpecies.attr("data-number-of-species",0),this.$sectionCombination=$("#section-combination"),this.$combinationResultsGraph=$("#combination-results-graph"),this.d3VennDiagrams=d3.selectAll(".venn-diagram"),this.d3VennDiagramTexts=this.d3VennDiagrams.selectAll("text"),this.$sectionCategory=$("#section-category"),this.$categoryContainer=$("#category-container"),this.$sectionLinkTo=$("#section-link-to"),this.$linkToContainer=$("#link-to-container"),this.$sectionCombination.addClass("disabled"),this.$sectionCategory.addClass("disabled"),this.$sectionLinkTo.addClass("disabled"),this.data=t,this.cache={aspect:void 0,species:[],taxIds:void 0},this.tree=new Tree(t),this.vennDiagram=new VennDiagram(document.getElementById("venn-diagrams"),document.getElementById("section-combination")),this.HeadingNavigation=new HeadingNavigation,$('#aspects-selector input[type="radio"]').click(function(){var t=$(this).parent(),i=t.text(),n=t.find("small").text();i=i.replace(n,""),e.setAspect(i,this.value)}),i=this.$sectionSpecies.find("g.node.leaf"),$("#aspects-selector").find('input[value="'+DEFAULT.aspect+'"]').trigger("click"),DEFAULT.species.forEach(function(t){var e=i.filter('[data-tax-id="'+t+'"]'),n=new MouseEvent("click");e.get(0).dispatchEvent(n)})},getValueWithKeyValue:function(t,e,i){i+="";for(var n=0;n<this.data.length;n++)if(this.data[n][e]===i)return this.data[n][t]},setAspect:function(t,e){this.$aspectH2.text(t),this.cache.aspect=e,this.step1()},setSpecies:function(t,e){var i;return this.cache.species.length>=this.MAX_OF_TAXON?(window.alert("Species は5種までしか選択できません"),!1):(i=new Species(t,this.cache.species.length,e),this.cache.species.push(i),this.updateSpecies(),!0)},deleteSpecies:function(t,e){var i=[],n;this.cache.species.forEach(function(e,a){n=e.updateByDeleteTaxId(t.taxid,i.length),n||i.push(e)}),this.cache.species=i,this.updateSpecies()},updateSpecies:function(){var t=0===this.cache.species.length?"--":"";this.$sectionSpecies.attr("data-number-of-species",this.cache.species.length),this.$sectionCombination.attr("data-number-of-species",this.cache.species.length),this.cache.species.forEach(function(e,i,n){t+='<span data-index="@@index@@">@@name@@</span>'.replace(/@@index@@/,e.index).replace(/@@name@@/,e.data.common_name+(i<n.length-1?",":""))}),this.$speciesH2.html(t),this.step1()},aspectSparql:function(t){var e="",i={interpro:"InterPro",pfam:"Pfam",supfam:"SUPFAM",prosite:"PROSITE",reactome:"Reactome",ctd:"CTD",cazy:"CAZy",brenda:"BRENDA",eggnog:"eggNOG",genetree:"GeneTree",hogenom:"HOGENOM",hovergen:"HOVERGEN",inparanoid:"InParanoid",ko:"KO",oma:"OMA",orthodb:"OrthoDB",phylomedb:"PhylomeDB",treefam:"TreeFam",nextbio:"NextBio",paxdb:"PaxDb",pride:"PRIDE"};switch(t){case"pathway":e="?up up:annotation ?annotation .\n	?annotation rdf:type up:Pathway_Annotation .\n	?annotation rdfs:comment ?label .";break;case"location":e="?up up:annotation ?annotation .\n	?annotation a up:Subcellular_Location_Annotation .\n	?annotation up:locatedIn/up:cellularComponent ?location .\n	?location up:alias ?label .";break;case"geneontology":e="?up up:classifiedWith ?go .\n	?go up:database db:go .\n	?go rdfs:label ?label .";break;case"interpro":case"pfam":case"supfam":case"prosite":case"reactome":case"cazy":e=this.dbsparql(i[t]);break;case"ctd":case"brenda":case"eggnog":case"genetree":case"hogenom":case"hovergen":case"inparanoid":case"ko":case"oma":case"orthodb":case"phylomedb":case"treefam":case"nextbio":case"paxdb":case"pride":e=this.dbsparql_link(i[t])}return e},dbsparql:function(t){return"			?up rdfs:seeAlso ?link .\n			?link up:database db:@@database@@ .\n			?link rdfs:comment ?label .".replace(/@@database@@/,t)},dbsparql_link:function(t){return"			?up rdfs:seeAlso ?label .\n			?label up:database db:@@database@@ .".replace(/@@database@@/,t)},step1:function(){var t=this,e,i,n;return this.$combinationH2.empty(),this.$combinationResultsGraph.empty(),this.$sectionCategory.addClass("disabled"),this.$categoryContainer.empty(),this.$categoryH2.empty(),this.$sectionLinkTo.addClass("disabled"),this.$linkToContainer.empty(),this.cache.aspect&&0!==this.cache.species.length?(this.$sectionCombination.addClass("loading"),e=this.cache.species.map(function(t){return t.taxId}),i=this.cache.species.map(function(t){return t.data.common_name}),n=SPARQLS.step1.replace(/@@taxvalues@@/,"tax:"+e.join(" tax:")).replace(/@@aspect@@/,this.aspectSparql(this.cache.aspect)),void d3sparql.query(ENDPOINT,n,function(n){var a="",s=n.results.bindings,o="set"+this.cache.species.length+"-",r,c=[],l,d,h,p;this.$sectionCombination.removeClass("disabled loading"),this.d3VennDiagramTexts.text(""),s.forEach(function(t){r=t.orgs.value.split(", "),t.taxIds=[],t.taxIdIndices=[],e.forEach(function(e,i){-1!==r.indexOf(e)&&(t.taxIds.push(e),t.taxIdIndices.push(i))}),c.push(parseInt(t.count.value))}),l=Math.max.apply(null,c),s.sort(function(t,e){return t.taxIds.length>e.taxIds.length?-1:t.taxIds.length<e.taxIds.length?1:0}),s.forEach(function(t){d=t.taxIdIndices.map(function(t){return i[t]}),h=o+t.taxIdIndices.join("_"),p=parseInt(t.count.value)/l*100,a+='					<div class="bar-chart set'+t.taxIds.length+'" data-set="'+h+'" data-value="'+t.orgs.value+'">						<p class="bar-name">'+d.join('<span class="sign">∩</span>')+'</p>						<div class="color-ball '+h+'"></div>						<div class="bar'+(p>=50?" over-half":"")+'" style="width: '+p+'%;"><span>'+t.count.value+"</span></div>					</div>",d3.select("#venn-text-"+o+t.taxIdIndices.join("_")).text(t.count.value)}),this.$combinationResultsGraph.empty().append(wrapInner(a)),this.$combinationResultsGraph.find(".bar-chart").on({mouseenter:function(){t.$sectionCombination.addClass("hovering"),this.d3TargetShape||(this.d3TargetShape=d3.select("#venn-shape-"+this.dataset.set),this.d3TargetText=d3.select("#venn-text-"+this.dataset.set)),this.d3TargetShape.classed({relative:!0}),this.d3TargetText.classed({relative:!0})},mouseleave:function(){t.$sectionCombination.removeClass("hovering"),this.d3TargetShape.classed({relative:!1}),this.d3TargetText.classed({relative:!1})},click:function(){$(this).siblings().removeClass("selected").end().addClass("selected"),t.step2(this.dataset.value)}}),this.d3VennDiagrams.selectAll(".part").on("mouseenter",function(){t.$sectionCombination.addClass("hovering");var e=this.id.replace("venn-shape-","");this.$targetBar=t.$combinationResultsGraph.find('[data-set="'+e+'"]'),this.d3TargetText=d3.select("#venn-text-"+e),this.$targetBar.addClass("relative"),this.d3TargetText.classed({relative:!0})}).on("mouseleave",function(){t.$sectionCombination.removeClass("hovering"),this.$targetBar.removeClass("relative"),this.d3TargetText.classed({relative:!1})}).on("click",function(){$(this.$targetBar).trigger("click")})}.bind(this))):void this.$sectionCombination.addClass("disabled")},step2:function(t){var e=this,i,n="",a,s,o,r;this.cache.taxIds=t;var c=this.cache.taxIds.split(", ").map(function(t){return parseInt(t)}),l=c.map(function(t){return e.getValueWithKeyValue("common_name","taxid",t)});this.$combinationH2.html(l.join('<span class="sign">∩</span>')),this.$categoryContainer.empty(),this.$categoryH2.empty(),this.$sectionLinkTo.addClass("disabled"),this.$linkToContainer.empty(),this.$sectionCategory.addClass("loading"),i=SPARQLS.step2.replace(/@@taxvalues@@/,this.taxIdsWithString(this.cache.taxIds)).replace(/@@taxfilter@@/,this.cache.taxIds).replace(/@@aspect@@/,this.aspectSparql(this.cache.aspect)),d3sparql.query(ENDPOINT,i,function(t){a=t.results.bindings,e.$sectionCategory.removeClass("disabled loading"),o=a.map(function(t){return parseInt(t.sum.value)}),r=Math.max.apply(null,o),a.forEach(function(t){s=parseInt(t.sum.value)/r*100,n+='					<div class="bar-chart" data-value="'+t.label.value+'">						<p class="bar-name">'+t.label.value+'</p>						<div class="bar'+(s>=50?" over-half":"")+'" style="width: '+s+'%;"><span>'+t.sum.value+"</span></div>					</div>"}),e.$categoryContainer.html(wrapInner(n)),e.$categoryContainer.find(".bar-chart").on("click",function(){$(this).siblings().removeClass("selected").end().addClass("selected"),e.step3(this.dataset.value)})})},step3:function(t){var e=this,i,n,a,s;this.$categoryH2.text(t),this.$linkToContainer.empty(),this.$sectionLinkTo.addClass("loading"),t.indexOf("http://purl.uniprot.org")<0?this.category='"'+t+'"':this.category="<"+t+">",i=SPARQLS.step3.replace(/@@taxvalues@@/,this.taxIdsWithString(this.cache.taxIds)).replace(/@@category@@/,this.category).replace(/@@aspect@@/,this.aspectSparql(this.cache.aspect)),d3sparql.query(ENDPOINT,i,function(t){e.$sectionLinkTo.removeClass("disabled loading"),n=t.head.vars,a=t.results.bindings,s="<table><thead>@@thead@@</thead><tbody>@@tbody@@</tbody></table>".replace(/@@thead@@/,n.map(function(t){return"<th>"+LINKS_TO_HEADER_LABEL_MAPPING[t]+"</th>"}).join("")).replace(/@@tbody@@/,a.map(function(t){var e=n.map(function(e){return'<td><a href="@@uri@@" target="_blank">@@uri@@</a></td>'.replace(/@@uri@@/g,t[e].value)}).join("");return"<tr>"+e+"</tr>"}).join("")),e.$linkToContainer.html(wrapInner(s))})},taxIdsWithArray:function(t){return t.map(function(t){return"tax:"+t}).join(" ")},taxIdsWithString:function(t){return t.split(", ").map(function(t){return"tax:"+t}).join(" ")}},$(function(){application=new Application,$("#search-methods-selector").css({zIndex:1e3}),d3.json("taxonomy.json",function(t){application.initialize(t)})});